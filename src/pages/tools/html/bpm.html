<div class="card-base rounded-xl p-6 text-center text-gray-900 dark:text-gray-100">
  <h2 class="text-2xl font-bold mb-2">ğŸµ BPMæµ‹é‡å·¥å…·</h2>
  <br>
  <p class="text-base-content/70 mb-4">è¿ç»­ç‚¹å‡»<strong>æŒ‰é’®</strong>æˆ–<strong>ç©ºæ ¼é”®</strong>ä»¥è·å–BPM</p>
  <div id="bpm-display" class="text-1xl text-primary my-4">
    <span class="text-1xl text-base-content/70 mb-4">ä¸‰ç§’å†…æ— è¾“å…¥æ—¶é‡ç½®</span><br><br>
    <span id="bpm-number">---</span><br>
    <span id="bpm-integer" class="text-4xl font-bold text-primary my-4">---</span>
  </div>
  <br>
  <div class="mb-4">
    <button id="tap-button" 
        class="relative px-8 py-4 text-xl font-bold 
               bg-primary/10 text-primary 
               border-2 border-gray-400
               rounded-lg
               transition-all duration-100
               active:scale-95
            ">
      â™ª(Â´â—¹ ` )
    </button>
  </div>
  <div class="mt-4 text-xs text-base-content/60">
    <span id="tap-count">0</span> æ¬¡ç‚¹å‡» | æœ€åç‚¹å‡»: <span id="last-tap">--</span>ç§’å‰
  </div>
</div>

<script>

class BPMDetector {
  constructor() {
    this.taps = [];
    this.resetTimeout = 3571;
    this.resetTimer = null;
    
    this.init();
  }
  
  init() {
    this.setupEventListeners();
    this.updateDisplay();
  }
  
  setupEventListeners() {
    const tapButton = document.getElementById('tap-button');
    
    tapButton.addEventListener('click', () => this.handleTap());
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        this.handleTap();
      }
    });
  }
  
  handleTap() {
    const now = Date.now();
    if (this.resetTimer) {
      clearTimeout(this.resetTimer);
    }
    this.taps.push(now);
    this.resetTimer = setTimeout(() => {
      this.reset();
    }, this.resetTimeout);
    
    this.calculateBPM();
    this.updateDisplay();
  }
  
  calculateBPM() {
    if (this.taps.length < 1) return;
    if (this.taps.length === 1) {this.displayBPM("---", "---"); return;}
    const intervals = [];
    for (let i = 1; i < this.taps.length; i++) {
      intervals.push(this.taps[i] - this.taps[i-1]);
    }
    intervals.sort((a, b) => a - b);
    const q1 = intervals[Math.floor(intervals.length * 0.25)];
    const q3 = intervals[Math.floor(intervals.length * 0.75)];
    const iqr = q3 - q1;
    const lowerBound = q1 - 1.5 * iqr;
    const upperBound = q3 + 1.5 * iqr;
    
    const filteredIntervals = intervals.filter(interval => 
      interval >= lowerBound && interval <= upperBound
    );
    
    if (filteredIntervals.length === 0) return;
    
    const avgInterval = filteredIntervals.reduce((a, b) => a + b, 0) / filteredIntervals.length;
    
    const bpm = (60000 / avgInterval).toFixed(2);
    const intBpm = Math.round(60000 / avgInterval);

    this.displayBPM(bpm, intBpm);
  }
  
  displayBPM(bpm, intBpm) {
    const bpmNumber = document.getElementById('bpm-number');
    const bpmNumberInteger = document.getElementById('bpm-integer');
    
    bpmNumber.textContent = bpm;
    bpmNumberInteger.textContent = intBpm;
  }
  
 
  updateDisplay() {
    const tapCount = document.getElementById('tap-count');
    const lastTap = document.getElementById('last-tap');
    
    tapCount.textContent = this.taps.length;
    
    if (this.taps.length > 0) {
      const secondsAgo = Math.floor((Date.now() - this.taps[this.taps.length - 1]) / 1000);
      lastTap.textContent = secondsAgo;
    }
    
    requestAnimationFrame(() => this.updateDisplay());
  }
  
  reset() {
    this.taps = [];
    document.getElementById('bpm-status').textContent = 'ç­‰å¾…è¾“å…¥...';
    document.getElementById('bpm-status').classList.add('opacity-0');
  }
}

new BPMDetector();
</script>